<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create a story with AI</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .container {
            text-align: center;
        }

        div {
            margin: 10px 0;
        }

        .option {
            background-color: lightblue;
            cursor: pointer;
        }

        #story {
            border: 1px solid #ccc;
            padding: 5px;
            margin: 10px 0;
            min-height: 100px;
            resize: vertical;
            overflow-y: auto;
        }

        #loading {
            display: none;
            margin-top: 10px;
            color: #666;
        }

    </style>
</head>

<body>
    <div class="container">
        <h2>Create a story with AI</h2>
        <div id="story">Choose a genre for your story.</div><br>
        <button id="option1" onclick="continueStory(this.textContent)" class="option">Slice of Life</button>
        <button id="option2" onclick="continueStory(this.textContent)" class="option">Animal Tale</button>
        <button id="option3" onclick="continueStory(this.textContent)" class="option">Historical Fiction</button>
        <div id="loading">Thinking...</div>
    </div>
    <script>
        let genre;

        async function continueStory(content) {
            if (content == 'error') {
                return;
            }

            const storyElement = document.getElementById('story');
            const aiInstruction = 'Choose between three AI-generated options to write your story.'

            if (typeof genre == 'undefined') {
                genre = content;
                storyElement.textContent = "";
            }


            const loading = document.getElementById('loading');
            loading.style.display = 'block';

            const systemInstruction = {
                parts: [{
                    text: `You are a helpful assistant that writes short ` +
                        `stories appropriate for all ages in the genre of ` +
                        `${genre}. Do not include violence, darkness, ` +
                        `crudeness, or hurtful behavior in your stories.`
                }]
            };

            if (storyElement.textContent == "") {
                storyElement.textContent = aiInstruction;

                contents = [{
                    role: 'user',
                    parts: [{
                        text: `Write three different alternatives for the very ` +
                            `first sentence of a short story in the genre of ` +
                            `${genre}. ` +
                            'Enclose each sentence in <sentence> ' +
                            'tags. Make the sentences short, but not too short. Do not write ' +
                            'anything other than these three sentences.'
                    }]
                }];
            } else {
                if (storyElement.textContent == aiInstruction) {
                    storyElement.textContent = content;
                } else {
                    storyElement.textContent += ' ';
                    storyElement.textContent += content;
                }
                contents = [{
                        role: 'user',
                        parts: [{
                            text: `Write the beginning of a short story ` +
                                `in the genre of ${genre}.`
                        }]
                    },
                    {
                        role: 'model',
                        parts: [{
                            text: storyElement.textContent
                        }]
                    }
                ];
                content = storyElement.textContent;
                lastChar = content[content.length - 1]
                if (lastChar == '.' || lastChar == '!' || lastChar == '?') {
                    content.push({
                        role: 'user',
                        parts: [{
                            text: `Write three different alternatives for the ` +
                                `next phrase or sentence of the short story you just ` +
                                `wrote. They can be complete sentences ending in a period, question mark, ` +
                                `or exclamation mark, or they can be fractional sentences ending in comma or ellipses. ` +
                                'Enclose each phrase or sentence in <sentence> ' +
                                'tags. Make the phrases short, but not too short. Do not write ' +
                                'anything other than these three sentences or phrases.'
                        }]
                    })
                } else {
                    content.push({
                        role: 'user',
                        parts: [{
                            text: `Write three different alternatives for finishing ` +
                                `the last sentence of the short story you just ` +
                                `wrote. ` +
                                'Enclose each ending in <sentence> ' +
                                'tags. Make the endings short, but not too short. Do not write ' +
                                'anything other than these three sentence endings.'
                        }]
                    });
                };
            }

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    systemInstruction: systemInstruction,
                    contents: contents,
                })
            };

            try {
                const response = await fetch('/api/gemini', options);
                const data = await response.json();
                console.log(response);
                console.log(data);
                if (!response.ok) {
                    console.error(response.status, data);
                    throw new Error(`${response.status} Error: ${data.details}`);
                }

                sentences = data.candidates?.[0]?.content.parts[0].text || '';
                console.log(sentences);

                const regex = /<sentence>([^<>]*)<\/sentence>/gm;

                match = regex.exec(sentences)
                if (match == null) {
                    throw new Error(`invalid response`);
                }
                document.getElementById('option1').textContent = match[1].trim();

                match = regex.exec(sentences)
                if (match == null) {
                    throw new Error(`invalid response`);
                }
                document.getElementById('option2').textContent = match[1].trim();

                match = regex.exec(sentences)
                if (match == null) {
                    throw new Error(`invalid response`);
                }
                document.getElementById('option3').textContent = match[1].trim();
            } catch (error) {
                storyElement.textContent = error.message;
                document.getElementById('option1').textContent = 'error';
                document.getElementById('option2').textContent = 'error';
                document.getElementById('option3').textContent = 'error';
            } finally {
                loading.style.display = 'none';
            }
        }

    </script>
</body>

</html>
